var assert = require("chai").assert
var fs = require("fs")

var xattr = require("../lib/xattr-file")

function isValidFile(buf) {
  it("should write header", function() {
    assert.equal(buf.readUInt32BE(0), 0x00051607)
  })

  it("should write version", function() {
    assert.equal(buf.readUInt32BE(4), 0x00020000)
  })

  it("should write magic filler", function() {
    assert.equal(buf.toString("utf8", 8, 24), "Mac OS X        ")
  })

  it("should write number of entries", function() {
    assert.equal(buf.readUInt16BE(24), 2)
  })

  it("should write finder info type", function() {
    assert.equal(buf.readUInt32BE(26), 9)
  })

  it("should write finder info offset", function() {
    assert.equal(buf.readUInt32BE(30), 50)
  })
}

describe("create", function() {
  describe("without any attributes", function() {
    var buf = xattr.create()

    isValidFile(buf)

    it("should write finder info length", function() {
      assert.equal(buf.readUInt32BE(34), 70)
    })
  })

  describe("with single string attribute", function() {
    var buf = xattr.create({"foo": "Foo"})

    isValidFile(buf)

    it("should write finder info length", function() {
      assert.equal(buf.readUInt32BE(34), 89)
    })

    it("should equal file generated by os x", function() {
      assert.deepEqual(buf, fs.readFileSync(__dirname + "/fixtures/xattr-single.rsrc"))
    })
  })

  describe("with single buffer attribute", function() {
    var buf = xattr.create({"foo": new Buffer("Foo")})

    isValidFile(buf)

    it("should write finder info length", function() {
      assert.equal(buf.readUInt32BE(34), 89)
    })

    it("should equal file generated by os x", function() {
      assert.deepEqual(buf, fs.readFileSync(__dirname + "/fixtures/xattr-single.rsrc"))
    })
  })

  describe("with multiple attributes", function() {
    var buf = xattr.create({
      "foo": "Foo",
      "bar": "Bar",
      "baz": "Baz",
    })

    isValidFile(buf)

    it("should write finder info length", function() {
      assert.equal(buf.readUInt32BE(34), 127)
    })

    it("should equal file generated by os x", function() {
      assert.deepEqual(buf, fs.readFileSync(__dirname + "/fixtures/xattr-multi.rsrc"))
    })
  })
})
